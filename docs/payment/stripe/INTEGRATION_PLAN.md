# Stripe Payment Integration Plan

## Overview

This document outlines the plan for integrating Stripe payment gateway into the Rabbit Mansion Hotel booking system. Stripe will provide international payment processing capabilities including credit cards, debit cards, and QR code payments.

## Table of Contents

1. [Why Stripe?](#why-stripe)
2. [Supported Payment Methods](#supported-payment-methods)
3. [Architecture Overview](#architecture-overview)
4. [Implementation Phases](#implementation-phases)
5. [Technical Requirements](#technical-requirements)
6. [Security Considerations](#security-considerations)
7. [Cost Analysis](#cost-analysis)
8. [Timeline](#timeline)

## Why Stripe?

### Advantages

- **Global Coverage**: Accepts payments from customers worldwide
- **Multiple Payment Methods**: Credit cards, debit cards, QR codes, digital wallets
- **PCI Compliance**: Stripe handles PCI compliance, reducing our burden
- **Strong Documentation**: Comprehensive API documentation and SDKs
- **Webhook Support**: Real-time payment notifications
- **Test Environment**: Full-featured sandbox for testing
- **SCA Compliance**: Built-in support for 3D Secure and Strong Customer Authentication
- **Fraud Prevention**: Advanced fraud detection with Stripe Radar

### Use Cases

- International tourist bookings
- Online credit/debit card payments
- QR code payments (PromptPay via Stripe)
- Recurring payments for long-term stays
- Pre-authorization for deposits

## Supported Payment Methods

### 1. Credit & Debit Cards

**Supported Card Networks:**

- Visa
- Mastercard
- American Express
- JCB
- Diners Club
- Discover
- UnionPay

**Features:**

- One-time payments
- Saved cards for returning customers
- 3D Secure authentication
- Pre-authorization (holds)
- Partial captures
- Automatic retry for failed payments

**Implementation Method:**

- Stripe Elements (embedded form)
- Payment Intents API
- Setup Intents for card saving

### 2. QR Code Payments

**Supported Methods:**

- PromptPay (Thailand) ğŸ‡¹ğŸ‡­
- Alipay (China) ğŸ‡¨ğŸ‡³
- WeChat Pay (China) ğŸ‡¨ğŸ‡³
- GrabPay (Southeast Asia)
- PayNow (Singapore) ğŸ‡¸ğŸ‡¬

**Features:**

- Customer scans QR code with mobile banking app
- Instant payment confirmation
- No card details required
- Lower transaction fees for local methods
- Automatic currency conversion

**Implementation Method:**

- Payment Intents API with payment_method_types: ['promptpay']
- QR code generated by Stripe
- Webhook for payment confirmation

### 3. Digital Wallets

**Supported Wallets:**

- Apple Pay
- Google Pay
- Link (Stripe's one-click checkout)

**Features:**

- One-click checkout
- Biometric authentication
- Saved payment methods
- Better conversion rates

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚
â”‚   (React)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Create Payment Intent
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NestJS Backend     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Stripe Module â”‚  â”‚
â”‚  â”‚  - Service    â”‚  â”‚
â”‚  â”‚  - Controller â”‚  â”‚
â”‚  â”‚  - Webhooks   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 2. API Call
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Stripe API â”‚
    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 3. Payment Processing
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Customer  â”‚
    â”‚   Device    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 4. Webhook
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Backend   â”‚
    â”‚   Updates   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Phases

### Phase 1: Core Setup (Week 1)

- [ ] Create Stripe account and get API keys
- [ ] Install Stripe SDK (@stripe/stripe-js, stripe)
- [ ] Set up NestJS Stripe module
- [ ] Configure webhook endpoints
- [ ] Set up test environment

### Phase 2: Credit/Debit Card Payments (Week 2)

- [ ] Implement Payment Intents API
- [ ] Create payment form with Stripe Elements
- [ ] Handle 3D Secure authentication
- [ ] Implement payment confirmation
- [ ] Add payment status webhooks
- [ ] Create payment record in database
- [ ] Link payments to bookings

### Phase 3: QR Code Payments (Week 3)

- [ ] Implement PromptPay QR generation
- [ ] Add support for Alipay/WeChat Pay
- [ ] Create QR display component
- [ ] Handle QR payment webhooks
- [ ] Add payment method selection UI
- [ ] Test with Thai bank accounts

### Phase 4: Additional Features (Week 4)

- [ ] Implement saved cards feature
- [ ] Add Apple Pay integration
- [ ] Add Google Pay integration
- [ ] Implement refund functionality
- [ ] Add payment analytics dashboard
- [ ] Create admin payment management UI

### Phase 5: Testing & Optimization (Week 5)

- [ ] End-to-end testing
- [ ] Load testing
- [ ] Security audit
- [ ] Performance optimization
- [ ] Documentation completion
- [ ] User acceptance testing

### Phase 6: Production Deployment (Week 6)

- [ ] Switch to production API keys
- [ ] Configure production webhooks
- [ ] Set up monitoring and alerts
- [ ] Deploy to production
- [ ] Monitor initial transactions
- [ ] Staff training

## Technical Requirements

### Dependencies

```json
{
  "stripe": "^14.x",
  "@stripe/stripe-js": "^2.x",
  "@nestjs/config": "^3.x",
  "class-validator": "^0.14.x",
  "class-transformer": "^0.5.x"
}
```

### Environment Variables

```env
# Stripe Configuration
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLIC_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Production (when ready)
# STRIPE_SECRET_KEY=sk_live_...
# STRIPE_PUBLIC_KEY=pk_live_...
```

### Database Schema Updates

**Payment Model Enhancements:**

```prisma
model Payment {
  id              String        @id @default(uuid())
  bookingId       String
  amount          Float
  currency        String        @default("THB")
  paymentMethod   PaymentMethod
  status          PaymentStatus @default(PENDING)

  // Stripe-specific fields
  stripePaymentIntentId  String?   @unique
  stripeCustomerId       String?
  stripePaymentMethodId  String?
  stripeChargeId         String?

  // Payment details
  cardLast4       String?       // Last 4 digits of card
  cardBrand       String?       // visa, mastercard, etc.
  cardCountry     String?       // Card issuing country

  transactionId   String?
  paymentDetails  Json?
  gatewayResponse Json?
  paidAt          DateTime?

  // 3D Secure
  requiresAction  Boolean       @default(false)
  clientSecret    String?

  description     String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  booking         Booking       @relation(fields: [bookingId], references: [id])
  refunds         Refund[]

  @@index([bookingId])
  @@index([stripePaymentIntentId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("payments")
}

// New model for saved cards
model SavedCard {
  id                    String   @id @default(uuid())
  guestId               String
  stripePaymentMethodId String   @unique
  cardLast4             String
  cardBrand             String
  cardExpMonth          Int
  cardExpYear           Int
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  guest                 Guest    @relation(fields: [guestId], references: [id])

  @@index([guestId])
  @@map("saved_cards")
}
```

### API Endpoints

| Method | Endpoint                        | Description            |
| ------ | ------------------------------- | ---------------------- |
| POST   | `/payment/stripe/create-intent` | Create payment intent  |
| POST   | `/payment/stripe/confirm`       | Confirm payment        |
| POST   | `/payment/stripe/qr`            | Create QR payment      |
| GET    | `/payment/stripe/status/:id`    | Check payment status   |
| POST   | `/payment/stripe/webhook`       | Stripe webhook handler |
| POST   | `/payment/stripe/refund/:id`    | Process refund         |
| GET    | `/payment/stripe/cards`         | Get saved cards        |
| POST   | `/payment/stripe/cards`         | Save new card          |
| DELETE | `/payment/stripe/cards/:id`     | Remove saved card      |

## Security Considerations

### 1. PCI Compliance

- âœ… Use Stripe Elements (no card data touches our servers)
- âœ… Never store raw card numbers
- âœ… Use HTTPS for all payment pages
- âœ… Implement proper access controls

### 2. Webhook Security

- Verify webhook signatures
- Validate event types
- Implement idempotency
- Rate limiting on webhook endpoint

### 3. Data Protection

- Encrypt sensitive data at rest
- Use environment variables for secrets
- Implement proper RBAC for payment access
- Regular security audits

### 4. Fraud Prevention

- Enable Stripe Radar
- Implement velocity checks
- Monitor suspicious patterns
- Set up automated alerts

## Cost Analysis

### Stripe Fees (Thailand)

**Card Payments:**

- Domestic cards: 3.65% + à¸¿11 per transaction
- International cards: 4.10% + à¸¿11 per transaction

**QR Code Payments:**

- PromptPay: 2.00% + à¸¿11 per transaction
- Alipay/WeChat: 3.40% + à¸¿11 per transaction

**Additional Costs:**

- Disputed charges: à¸¿550 per dispute
- Currency conversion: 1% above wholesale rates
- Refunds: Original fees not returned

### Example Calculations

**Domestic Card - à¸¿5,000 booking:**

- Fee: à¸¿5,000 Ã— 3.65% + à¸¿11 = à¸¿193.50
- Net: à¸¿4,806.50

**PromptPay QR - à¸¿5,000 booking:**

- Fee: à¸¿5,000 Ã— 2.00% + à¸¿11 = à¸¿111.00
- Net: à¸¿4,889.00

**International Card - $200 booking:**

- Fee: $200 Ã— 4.10% + $0.30 + 1% FX = $9.50
- Net: $190.50

### Cost Optimization Strategies

1. Encourage PromptPay QR for domestic customers (lower fees)
2. Pass convenience fees to customers for international cards
3. Set minimum booking amounts
4. Offer discounts for bank transfer payments
5. Monitor and challenge fraudulent disputes

## Payment Flow Diagrams

### Credit/Debit Card Payment Flow

```
Customer                  Frontend                  Backend                   Stripe
   â”‚                         â”‚                         â”‚                         â”‚
   â”‚  1. Enter card info     â”‚                         â”‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚
   â”‚                         â”‚  2. Create intent       â”‚                         â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
   â”‚                         â”‚                         â”‚  3. Create Payment      â”‚
   â”‚                         â”‚                         â”‚     Intent              â”‚
   â”‚                         â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  4. Return client       â”‚
   â”‚                         â”‚     Client secret       â”‚     secret              â”‚
   â”‚  5. Show Elements form  â”‚                         â”‚                         â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                         â”‚
   â”‚                         â”‚                         â”‚                         â”‚
   â”‚  6. Submit payment      â”‚                         â”‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  7. Confirm with        â”‚                         â”‚
   â”‚                         â”‚     Stripe.js           â”‚                         â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                         â”‚                    8. Process â”‚
   â”‚                         â”‚                         â”‚                       3DS if   â”‚
   â”‚  9. 3DS challenge (if required)                   â”‚                       needed   â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚    10. Payment result   â”‚   11. Webhook           â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  12. Show confirmation  â”‚                         â”‚   12. Update booking    â”‚
```

### QR Code Payment Flow

```
Customer                  Frontend                  Backend                   Stripe
   â”‚                         â”‚                         â”‚                         â”‚
   â”‚  1. Select QR payment   â”‚                         â”‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚
   â”‚                         â”‚  2. Create QR payment   â”‚                         â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
   â”‚                         â”‚                         â”‚  3. Create Payment      â”‚
   â”‚                         â”‚                         â”‚     Intent (PromptPay)  â”‚
   â”‚                         â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  4. Return QR code      â”‚
   â”‚                         â”‚     QR code data        â”‚                         â”‚
   â”‚  5. Display QR code     â”‚                         â”‚                         â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                         â”‚
   â”‚                         â”‚                         â”‚                         â”‚
   â”‚  6. Scan & pay via      â”‚                         â”‚                         â”‚
   â”‚     mobile banking app  â”‚                         â”‚                         â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                         â”‚                    7. Process â”‚
   â”‚                         â”‚                         â”‚                       payment  â”‚
   â”‚                         â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚                         â”‚   8. Webhook            â”‚
   â”‚                         â”‚  9. Poll status or      â”‚                         â”‚
   â”‚                         â”‚     websocket update    â”‚                         â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
   â”‚  10. Show confirmation  â”‚                         â”‚                         â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                         â”‚
```

## Timeline

### Development Schedule

| Week | Phase    | Tasks                                         | Deliverables            |
| ---- | -------- | --------------------------------------------- | ----------------------- |
| 1    | Setup    | Account setup, module creation, configuration | Working module skeleton |
| 2    | Cards    | Payment Intents, 3DS, webhooks                | Card payments working   |
| 3    | QR       | PromptPay, Alipay, WeChat integration         | QR payments working     |
| 4    | Features | Saved cards, wallets, refunds                 | Full feature set        |
| 5    | Testing  | Integration tests, security audit             | Test reports            |
| 6    | Deploy   | Production setup, monitoring                  | Live system             |

### Milestones

- âœ… **M1**: Module setup complete
- â³ **M2**: Card payments functional in sandbox
- â³ **M3**: QR payments functional in sandbox
- â³ **M4**: All features complete
- â³ **M5**: Testing passed
- â³ **M6**: Production deployment

## Risk Assessment

### Technical Risks

| Risk                        | Impact | Probability | Mitigation                                       |
| --------------------------- | ------ | ----------- | ------------------------------------------------ |
| 3DS authentication failures | High   | Medium      | Implement proper error handling and fallbacks    |
| Webhook delivery failures   | High   | Low         | Implement retry logic and monitoring             |
| Payment processing delays   | Medium | Medium      | Set clear expectations, implement status polling |
| API rate limiting           | Medium | Low         | Implement request queuing and caching            |

### Business Risks

| Risk                      | Impact | Probability | Mitigation                                                     |
| ------------------------- | ------ | ----------- | -------------------------------------------------------------- |
| High transaction fees     | High   | High        | Offer multiple payment methods, encourage lower-fee options    |
| Chargebacks/disputes      | High   | Medium      | Implement Stripe Radar, clear cancellation policies            |
| Currency conversion costs | Medium | Medium      | Show prices in multiple currencies upfront                     |
| Customer payment failures | Medium | High        | Provide clear error messages, support multiple payment methods |

## Success Metrics

### KPIs

1. **Payment Success Rate**: Target >95%
2. **Average Payment Time**: Target <30 seconds
3. **Chargeback Rate**: Target <0.5%
4. **Payment Method Usage**:
   - Cards: 60%
   - QR Codes: 30%
   - Wallets: 10%

### Monitoring

- Real-time payment dashboard
- Failed payment alerts
- Daily reconciliation reports
- Weekly performance reviews
- Monthly cost analysis

## Support & Maintenance

### Ongoing Tasks

- Monitor webhook deliveries
- Review failed payments daily
- Process refunds within 24h
- Update Stripe SDK quarterly
- Review fraud patterns monthly
- Annual security audit

### Documentation

- API documentation
- Admin user guide
- Customer payment guide
- Troubleshooting guide
- Runbook for common issues

## Next Steps

1. âœ… Complete this planning document
2. â³ Get approval from stakeholders
3. â³ Create Stripe account
4. â³ Set up development environment
5. â³ Begin Phase 1 implementation

## References

- [Stripe API Documentation](https://stripe.com/docs/api)
- [Stripe Payment Intents](https://stripe.com/docs/payments/payment-intents)
- [PromptPay on Stripe](https://stripe.com/docs/payments/promptpay)
- [Stripe Elements](https://stripe.com/docs/stripe-js)
- [Webhook Best Practices](https://stripe.com/docs/webhooks/best-practices)
- [PCI Compliance Guide](https://stripe.com/docs/security/guide)
